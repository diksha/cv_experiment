# Protobuf types

This directory holds all protobuf types. All `BUILD.bazel` content in this directory is autogenerated. When adding new protobuf files, or making changes to the import statements in any protobuf files it is necessary to run Gazelle to generate the updated `BUILD.bazel` content like this:

`./tools/protogen`

If you have any problems with either of these please contact @voxeljorge for assistance, or anyone else on Platform.

## Conventions

### Filenames

It is highly recommended that proto files in this folder follow a convention which looks something like this:

`protos/<org>/<optionalpath>/<packagename>/<version>/<yourfile>.proto`

Some examples:

`protos/perception/structs/v1/actor.proto`

### Package names

All package names should match the package path. Multiple proto files may be part of the same package though. For the example above, the correct protobuf package name would be:

`protos.perception.structs.v1`

There is a linter which will complain if packages are not named following their directory location.

### Go package option

It is highly recommended that all proto files explicitly name their go packages for ease of use and consistency. The standard that other packages here have followed is to use the `<packagename>` with `pb` as a suffix as the actual package name rather than `<version>` as this will lead to fewer conflicts and less confusion. This package name should also include the proper go package prefix of `github.com/voxel-ai/voxel` so that imports work correctly. This is a common pattern taken from other projects that use protobuf and Go. The option for the above example should be:

`option go_package = "github.com/voxel-ai/voxel/protos/perception/structs/v1;structspb";`

## Design Pattern

### EnumValueOptions

EnumValueOptions is a design pattern to store a value inside an Enum, then your Enum could be turn on a static map.

#### Protos

Let says that you want to create an Enum that represent a Time Unit like this :

```protobuf
enum Unit {
    UNIT_MINUTE_UNSPECIFIED = 0;
    UNIT_FIVE_MINUTE = 1;
    UNIT_HALF_HOUR = 2;
    UNIT_HOURS = 3;
    UNIT_DAY = 4;
    UNIT_WEEK = 5;
    UNIT_THIRTY_DAY = 6;
}
```

Now you want this enum be able to always return a Number according the unit enum value

```protobuf
import "google/protobuf/descriptor.proto";

extend google.protobuf.EnumValueOptions {
  int32 seconds = 51234;
}

enum Unit {
    UNIT_MINUTE_UNSPECIFIED = 0 [(seconds)= 60];
    UNIT_FIVE_MINUTE = 1 [(seconds) = 300];
    UNIT_HALF_HOUR = 2 [(seconds) = 1800];
    UNIT_HOURS = 3 [(seconds) = 3600];
    UNIT_DAY = 4 [(seconds) = 86400];
    UNIT_WEEK = 5 [(seconds) = 604800];
    UNIT_THIRTY_DAY = 6 [(seconds) = 2592000];
}
```

1. You import `google/protobuf/descriptor.proto`
2. Create a `EnumValueOptions` object with inside an interger that will store your `seconds` number
3. Update you Enum to affect the second integer to a real static number

#### Python

So now how to access `3600` when you call `UNIT_HOURS` in your python code ?

```python
from protos.platform.bowser.v1.bowser_config_function_pb2 import (
    Unit,
    seconds,
)

seconds = (Unit.DESCRIPTOR.values_by_name["UNIT_HOURS"]
.GetOptions()
.Extensions[seconds]
)

seconds = (Unit.DESCRIPTOR.values_by_number[3]
.GetOptions()
.Extensions[seconds]
)
```

Your variable seconds will be setted to 3600 now on both `values_by_name` and `values_by_number`

#### To go further

EnumValueOptions could take 1 or infinite number of attribute

```protobuf
import "google/protobuf/descriptor.proto";

extend google.protobuf.EnumValueOptions {
    string name = 51234;
    int32 value = 51234;
}

enum Unit {
    UNIT_MINUTE_UNSPECIFIED = 0 [(value)= 300, (name) = "This is 1 minute "];
    UNIT_FIVE_MINUTE = 1 [(value) = 300 , (name) = "This is 5 minutes"];
    UNIT_HALF_HOUR = 2 [(value) = 1800 , (name) = "This is 30 minutes"];
    UNIT_HOURS = 3 [(value) = 3600 , (name) = "This is 1 hour"];
    UNIT_DAY = 4 [(value) = 86400 , (name) = "This is 1 day"];
    UNIT_WEEK = 5 [(value) = 604800 , (name) = "This is 1 week"];
    UNIT_THIRTY_DAY = 6 [(value) = 2592000, (name) = "This is 30 days"];
}
```
