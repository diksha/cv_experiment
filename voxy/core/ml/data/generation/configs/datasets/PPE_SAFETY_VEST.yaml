#
# Copyright 2020-2021 Voxel Labs, Inc.
# All rights reserved.
#
# This document may not be reproduced, republished, distributed, transmitted,
# displayed, broadcast or otherwise exploited in any manner without the express
# prior written permission of Voxel Labs, Inc. The receipt or possession of this
# document does not convey any rights to reproduce, disclose, or distribute its
# contents, or to manufacture, use, or sell anything that it may describe, in
# whole or in part.
#
dataset_generation:
  camera_uuid: {{camera_uuid}} 
  source: 
     name: "MetaverseStream"
     params: 
        query: 'query get_data_collections_from_logset( $logset_uuid: String ) 
        { 
                data_collection_from_data_collection_logset(data_collection_logset_uuid: $logset_uuid)
                { 
                  data_collection_type,
                  uuid, 
                  voxel_uuid, 
                  name, 
                  is_test,  
                  path, 
                  frame_ref 
                  { 
                    frame_number, 
                    uuid, relative_image_path,
                    relative_timestamp_ms, 
                    actors_ref 
                      { 
                        polygon,
                        category, 
                        track_uuid, 
                        track_id, 
                        door_state 
                      } 
                  } 
                } 
        }'
        query_name: 'data_collection_from_data_collection_logset'
        query_variables:
           logset_uuid: {{logset["uuid"]}}
  reader: "DataCollectionStream"
  data_transform:
    transforms:
      - name: CropFromActor
        params: {}
  label_transform:
    transforms:
      - name: GetObservation
        params: {}
      - name: GetAttribute
        params:
          attribute: "is_wearing_safety_vest"
      - name: ConvertBoolToName
        params:
          true_name: "SAFETY_VEST"
          false_name: "NO_SAFETY_VEST"
  observer_transform:
    transforms:
      - name: AssociatePPEFromFrame
        params:
          person_class: "PERSON_V2"
          ppe_class: "SAFETY_VEST"
          no_ppe_class: "BARE_CHEST"
          in_place: True
          attribute: is_wearing_safety_vest
      - name: GetAttribute
        params:
          attribute: "actors"
      - name: "FilterActorsByCategory"
        params:
          categories: ["PERSON_V2"]
      - name: "FilterActorsWithNoneAttribute"
        params:
           attribute_name: is_wearing_safety_vest
  is_test_transform:
    transforms:
      - name: "GetAttribute"
        params:
          attribute: "is_test"
  writer: 
   name: "CSVWriter"
   params:
      output_directory: /data
      output_cloud_bucket: voxel-datasets
